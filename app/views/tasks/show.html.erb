<style type="text/css">
    .button_to{display: inline-block !important;}
</style>
<div style="margin:20px 60px;">
    <div class="row">
        <div class="col-sm-8">
            <h4>
                <i class="fas fa-asterisk"></i>　
                <%= @task.t_name %>　
                <% if @parent_task != nil then %>
                    <a class="btn btn-info" href="/tasks/<%= @parent_task.id %>" style="color:white;display: inline-block;"><%= @parent_task.t_name %></a>
                <% end %>
                <% if @task.done == false %>
                    <a id="task<%= @task.id %>" class="btn btn-success" style="display:none;width:100px;color:white;display:none"><%= @task.task_status[0] %></a>
                    <%= button_to @task.task_status[0], done_path(@task), method: :post, remote: true, :class => "btn btn-#{@task.task_status[1]}", :id => "task-not-yet"%>
                <% elsif @task.done == true %>
                    <a id="task<%= @task.id %>" class="btn btn-danger" style="display:none;width:100px;color:white;display:none">未完了</a>
                    <%= button_to @task.task_status[0], undone_path(@task), method: :post, remote: true, :class => "btn btn-#{@task.task_status[1]}", :id => "task-not-yet"%>
                <% end %>
            </h4>
            <p style="margin-top:20px;">
                <i class="fas fa-clock"></i>　<%= @task.start_date %>〜<%= @task.end_date %>
                <br><br>
                <i class="fas fa-user-circle"></i>　<%= @task.role %>
                <div class="schedule-detail-section">
                    <i class="fas fa-stopwatch" style="margin-left:-30px;"></i><p id="sd-days" style="display:inline-block;text-align:left;margin-top:10px;margin-left:20px;"></p>
                </div>
            </p>
            <div class="schdule-detail-section" style="background-color:#eee;padding:15px;margin-top:20px">
                <% if @task.reference_url != "" then %>
                    <h5>参考ページ</h5>
                    <a class="thumbnail" target="_blank" href="<%= @task.reference_url %>">
                        <h5><%= @task.reference_text %></h5>
                        <div style="margin:0 auto;">
                        <img src="<%= @task.reference_image %>" width="70%">
                        </div>
                    </a>
                <% else %>
                    <h5>参考ページを登録しよう</h5>
                    <label name="reference_text">サイト名</label>
                    <input type="text" name="reference_text" class="form-control" style="width:300px;">
                    <label name="reference_url">ページURL</label>
                    <input type="text" name="reference_url" class="form-control" style="width:300px;">
                    <label name="reference_image">画像URL</label>
                    <input type="text" name="reference_image" class="form-control" style="width:300px;">
                <% end %>
            </div>
            <br>
            <h4><i class="fas fa-asterisk"></i> <%= @task.t_name %>の詳細</h4>
            <div class="schedule-detail-section">
                <textarea rows="3" cols="100" class="form-control"></textarea>
                <a href="" class="btn btn-xs btn-success" style="margin-top:10px;margin-bottom:20px;">保存</a>
            <br>
            </div>
            <br>
            <h4><i class="fas fa-asterisk"></i> <%= @task.t_name %>の役割分担</h4>
            <div class="schedule-detail-section">
            <table class="table">
                <tr>
                    <td>開始日</td><td><%= @task.start_date %></td>
                </tr>
                <tr>
                    <td>終了日</td><td><%= @task.end_date %></td>
                </tr>
                <tr>
                    <td>担当者</td><td><%= @task.role %></td>
                </tr>
            </table>
            <a class="btn btn-warning">終了した</a>
            </div>
            <br>
            <% if @task.parent_task_id == 0 then %>
                <h4><i class="fas fa-asterisk"></i> 含まれる作業</h4>
                <div class="schedule-detail-section">
                    <div class="list-group">
                        <% Task.where(:t_number => @task.t_number, :work_id => @task.work.id).each do |t_task| %>
                            <% if t_task.parent_task_id == 0 then %>
                                <div class="list-group-item list-group-item-action active">
                                    <a href="/tasks/<%= t_task.id %>" style="color:white;"><%= t_task.t_name %></a>
                                </div>
                            <% else %>
                                <div class="list-group-item list-group-item-action">
                                    <a href="/tasks/<%= t_task.id %>"><%= t_task.t_name %></a>
                                </div>     
                            <% end %>           
                        <% end %>
                    </div>
                </div>
                <br>
            <% end %>
            <a href="/works/<%= @task.work.w_url %>" class="btn btn-danger" style="margin-top:20px;">戻る</a>
        </div>
        <div class="col-sm-4">
            <div class="task-detail-left">
                <h4><i class="fas fa-asterisk"></i> 関係するタスク</h4>
                <br>
                <div class="schdule-detail-section">
                    <div class="list-group">
                        <% @relate_tasks.each do |r_task| %>
                            <a href="/tasks/<%= r_task.id %>">
                            <div class="list-group-item list-group-item-action">
                                <%= r_task.t_name %>
                                <br>
                                <i class="fas fa-user-circle"></i>　<small><%= r_task.role %></small>
                                <br>
                                <i class="fas fa-clock"></i>　<small><%= r_task.start_date %></small>
                            </div>
                            </a>
                        <% end %>
                    </div>
                </div>
                <br>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function time(){
        var now = new Date();
        // 来年の1月1日
        var firstDay = new Date(<%= @task.end_date.year %>, (<%= @task.end_date.month %>-1), <%= @task.end_date.day %>);
        // 秒数差
        var diff = (firstDay.getTime() - now.getTime()) / 1000;
        // 日時の計算と端数切り捨て
        var daysLeft = Math.floor(diff / (24 * 60 * 60));
        var hoursLeft = (Math.floor(diff / (60 * 60))) % 24;
        var minitesLeft = (Math.floor(diff / 60)) % 60;
        var secondsLeft = Math.floor(diff) % 60;
        // 二桁表示
        minitesLeft = ("0" + minitesLeft).slice(-2)
        secondsLeft = ("0" + secondsLeft).slice(-2)
        // 出力
        if (daysLeft < 0 || hoursLeft < 0 || minitesLeft < 0 || secondsLeft < 0){
            document.getElementById("sd-days").innerHTML = "期限切れです...";
        }else{
            document.getElementById("sd-days").innerHTML = ("<div class='d-day'>" + daysLeft + "日</div> <div class='d-hour'>" + hoursLeft + "時間</div> <div class='d-min'>" + minitesLeft + "分</div> <div class='d-sec'>" + secondsLeft + "秒</div>");
        }
    }
    setInterval('time()',500);
</script>